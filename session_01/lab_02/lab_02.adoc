:compat-mode:
= Lab 2 - Getting Familiar with Apps Manager and the Service Marketplace

In this lab, we'll walk through the _Apps Manager console_ and the _Marketplace_ and the binding details of the application to MySQL.

. A Bit of Review
+
Your instance of _uktowns_ should still be running from the end of link:../lab_01/lab_01.adoc[Lab 1].
Visit the application in your browser by hitting the route that was generated by the CLI:
+
image::/../../Common/images/UkTownsNoMysql.JPG[]
+
The page indicates that we need to bind to a MySql database...which we will do shortly.
+
. Managing your Application
+
Let's log in to the _Apps Manager Console_:
+
With Chrome or Firefox, goto this url: https://apps.pcf7.cloud.fe.pivotal.io
+
Login to Apps manager with your student information. 
+
image::/../../Common/images/Login.JPG[]
+
Then Navigate to the default org
+
image::/../../Common/images/OrgSpace.JPG[]
+
... and space to view your list of applications (Hint: you may only have 1 application).
+
image::/../../Common/images/DevSpace.JPG[]
+
. Reviewing the Application in Apps Manager
+
The _uktowns_ application is a basic example of how _.net apps_ can be "pushed to cloud foundry" and bound to services which are also managed by the platform.
+
The Apps Manager Provides a very user friendly view of the details of your application.
+
Click on the application to go to the Application Detail Page
+
image::/../../Common/images/ukTowns.JPG[]
+
From this page find the following details:
+
ReStart/Stop:: 
+
The Start, ReStart and Stop buttons allow full control over your app's availability.
+
+
View Bound Services:: 
+
Within the _Services Tab_, the bound services are listed along with management options. In addition, you have the option of provisioning a new service from the Marketplace. (We will do this down below)
+
Review Recent Logs::
+
The _Logs Tab_ presents the recent log messages. It is also possible to "tail" the logs via the browser from here.
+
Add a User-Defined environment variable:: 
+
The _Environment Variables Tab_ displays the environment information. Environment variables are used heavily to provide metadata information to applications running on Cloud Foundry. This is one characteristic of being "Cloud-Native" since apps shouldn't own their own dependency configuration information. In addition, users have the ability to view and add their own user-provided environment variables here.
+
Review Configuration and Status::
+
Each application can scale to multiple instances (we will do this in another lab) and can consume varying amounts of memory and disk. How much Memory and CPU is your appliction using? Can you reduce the memory footprint to 256MB?
+
. Working with Services
+
The _uktowns_ application is a basic example of how _.net apps_ can be "pushed to cloud foundry" and bound to services which are also managed by the platform.
+
Cloud Foundry services are managed through two primary types of operations:
+
Create/Delete:: These operations create or delete instances of a service.
For a database this could mean creating/deleting a schema in an existing multitenant cluster or creating/deleting a dedicated database cluster.
Bind/Unbind:: These operations create or delete unique credential sets for an existing service instance that can then be injected into the environment of an application instance.
+
. The Services Marketplace
+
There are two ways to discover what services are available on Pivotal Cloud Foundry.
A)One way is to use the CLI. Just type:
+
----
$ cf marketplace
----
+
and you'll get a list of services, their available plans, and descriptions.
+
B)The second way is specific to Pivotal Cloud Foundry's Application Manager UI.
+
Click on the ``Marketplace'' link:
+
image::/../../Common/images/PWS_AM_InstructorSpace.png[]
+
and you'll see the same service/plan/description listing in the browser:
+
image::/../../Common/images/PWS_Marketplace.png[]

== Creating and Binding to a Service Instance

. Let's begin by creating a MySQL instance.
Below are instructions based on the CLI. If you prefer a graphical approach, then use Apps Manager to graphically create and bind a MySQL service to your uktowns app. After going to the Marketplace you can then selecting your desired service, create an instance of it, and bind it to your uktowns application.

==CLI instructions
let's _create_ a developer instance:
+
----
$ cf create-service p-mysql 100mb-dev mysqlService2
Creating service instance mysqlService2 in org student2-org / space development as student2...
OK
----
+
. Next we'll _bind_ the newly created instance to our existing `uktownsXX` application:
+
----
$ cf bind-service uktowns02 mysqlService2
Binding service mysqlService2 to app uktowns02 in org student2-org / space development as student2...
OK
TIP: Use 'cf restage uktowns02' to ensure your env variable changes take effect
----

. Notice the admonition to `Use 'cf restage' to ensure your env variable changes take effect`.
+
. Then re-visit the URL to see the sample app Now showing a list of UK Towns
+
image::/../../Common/images/UkTownsData.JPG[]
+
Reminder: each student will need to use their own app-name following this template:
+
```
cf create-service p-mysql 100mb-dev mysqlService
cf bind-service uktownsXX mysqlService
cf restage uktownsXX
```
+
+
. Let's take a look at the environment variables for our application to see what's been done. We can do this by typing:
+
----
$ cf env uktownsXX
----
+
The subset of the output we're interested in is located near the very top, titled `System-Provided`:
+
====
----
System-Provided:
{
 "VCAP_SERVICES": {
  "p-mysql": [
   {
    "credentials": {
     "hostname": "10.68.150.88",
     "jdbcUrl": "jdbc:mysql://10.68.150.88:3306/cf_7de6897a_c70f_4504_931a_30c1c8a84f7a?user=dlQKvqIeVU12yCNY\u0026password=WbkiQ62NIIAUFU0G",
     "name": "cf_7de6897a_c70f_4504_931a_30c1c8a84f7a",
     "password": "WbkiQ62NIIAUFU0G",
     "port": 3306,
     "uri": "mysql://dlQKvqIeVU12yCNY:WbkiQ62NIIAUFU0G@10.68.150.88:3306/cf_7de6897a_c70f_4504_931a_30c1c8a84f7a?reconnect=true",
     "username": "dlQKvqIeVU12yCNY"
    },
    "label": "p-mysql",
    "name": "mysqlService",
    "plan": "100mb-dev",
    "tags": [
     "mysql",
     "relational"
    ]
   }
  ]
 }
}
----
<1> `VCAP_SERVICES` is a special Cloud Foundry environment variable that contains a JSON document containing all of the information for any services bound to an application.
<2> Notice here the unique URI for this instance of MySQL that `uktownsXX` has been bound to.
====

. Now let's _restage_ the application, which cycles our application back through the staging/buildpack process before redeploying the application.footnote:[In this case, we could accomplish the same goal by only _restarting_ the application via `cf restart uktownsXX`.
A _restage_ is generally recommended because Cloud Foundry buildpacks also have access to injected environment variables and can install or configure things differently based on their values.]
+
----
$ cf restage uktownsXX
----
+
Once the application is running again, revisit or refresh the browser tab where you have the _uktowns_ application loaded:
+
image::/../../Common/images/UkTownsData.JPG[]
+
As you can see from the information dialog, the application is now utilizing a MySQL database via the `mysqlService` service.
+
Note that you can do all of this from either the CLI or the Application Manager UI.

== Review the code
Open the uktowns up in Visual Studio as a website (DotNetCloudWorkshop\session_01\lab_01\uk-towns-dotnet)
Note that 
===
.This is a simple application without any special libraries to support PCF.
+
.The connection information is retrieved from the VCAP_SERVICES environment variable.
+
----
image::/../../Common/images/uktowns_vcap_services..JPG
----
+
.The Actual DB connection and Binding code is not PCF-specific.
+
----
image::/../../Common/images/uktowns_call_db..JPG
----
===

== Clean Up

Since we're done using the uktownsXX application, let's clean up our application and services to make room for future labs.

. Delete the `uktowns` application:
+
----
$ cf delete uktownsXX

Really delete the app uktowns02?> y
Deleting app spring-music in org oreilly-class / space instructor as mstine@pivotal.io...
OK
----

. Delete the `mysqlService` service:
+
----
$ cf delete-service mysqlService

Really delete the service mysqlService?> y
Deleting service mysqlService in org oreilly-class / space instructor as mstine@pivotal.io...
OK
----
